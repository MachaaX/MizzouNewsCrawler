# Cloud Build configuration for building all services
# This builds Docker images and pushes to Artifact Registry
# Cloud Deploy handles the actual deployment to GKE

steps:
  # PHASE 1: Build and push migrator FIRST, then run migrations
  # This ensures migrations run before wasting time building other images
  
  # Build and push migrator image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-migrator'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/migrator:${SHORT_SHA}'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/migrator:latest'
      - '-f'
      - 'Dockerfile.migrator'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-migrator'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/migrator'
    waitFor: ['build-migrator']

  # Run database migrations BEFORE building other services (only on main branch)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'run-migrations'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "${BRANCH_NAME}" = "main" ]; then
          echo "ðŸ”„ Running database migrations..."
          
          # Get GKE credentials
          gcloud container clusters get-credentials mizzou-cluster \
            --zone=us-central1-a \
            --project=${PROJECT_ID}
          
          # Create migration job
          cat > /tmp/migration-job.yaml <<EOF
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: migration-${SHORT_SHA}
          namespace: production
          labels:
            app: migrator
            component: database
            commit: ${SHORT_SHA}
        spec:
          backoffLimit: 2
          ttlSecondsAfterFinished: 86400
          template:
            metadata:
              labels:
                app: migrator
            spec:
              serviceAccountName: mizzou-app
              restartPolicy: Never
              containers:
              - name: migrator
                image: us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/migrator:${SHORT_SHA}
                command: ["alembic", "upgrade", "head"]
                env:
                - name: DATABASE_ENGINE
                  value: "postgresql+psycopg2"
                - name: DATABASE_HOST
                  value: "127.0.0.1"
                - name: DATABASE_PORT
                  value: "5432"
                - name: DATABASE_USER
                  valueFrom:
                    secretKeyRef:
                      name: cloudsql-db-credentials
                      key: username
                - name: DATABASE_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: cloudsql-db-credentials
                      key: password
                - name: DATABASE_NAME
                  valueFrom:
                    secretKeyRef:
                      name: cloudsql-db-credentials
                      key: database
                - name: USE_CLOUD_SQL_CONNECTOR
                  value: "true"
                - name: CLOUD_SQL_INSTANCE
                  value: "${PROJECT_ID}:us-central1:mizzou-db-prod"
              - name: cloud-sql-proxy
                image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
                args:
                  - "--port=5432"
                  - "${PROJECT_ID}:us-central1:mizzou-db-prod"
                securityContext:
                  runAsNonRoot: true
        EOF
          
          # Apply the job
          kubectl apply -f /tmp/migration-job.yaml
          
          # Wait for migration to complete (timeout 5 minutes)
          echo "â³ Waiting for migration to complete..."
          kubectl wait --for=condition=complete --timeout=300s job/migration-${SHORT_SHA} -n production || {
            echo "âŒ Migration failed or timed out"
            kubectl logs job/migration-${SHORT_SHA} -n production || true
            exit 1
          }
          
          echo "âœ… Database migrations completed successfully"
          kubectl logs job/migration-${SHORT_SHA} -n production
        else
          echo "â„¹ï¸  Skipping migrations - not on main branch"
        fi
    waitFor: ['push-migrator']

  # PHASE 2: Build application services (in parallel, after migrations succeed)
  
  # Build Processor
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-processor'
    waitFor: ['run-migrations']
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/processor:${SHORT_SHA}'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/processor:latest'
      - '-f'
      - 'Dockerfile.processor'
      - '.'

  # Build API
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-api'
    waitFor: ['run-migrations']
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/api:${SHORT_SHA}'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/api:latest'
      - '-f'
      - 'Dockerfile.api'
      - '.'

  # Build Crawler
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-crawler'
    waitFor: ['run-migrations']
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/crawler:${SHORT_SHA}'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/crawler:latest'
      - '-f'
      - 'Dockerfile.crawler'
      - '.'

  # Push all images
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-processor'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/processor'
    waitFor: ['build-processor']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-api'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/api'
    waitFor: ['build-api']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-crawler'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/crawler'
    waitFor: ['build-crawler']

  # PHASE 3: Create Cloud Deploy release (only on main branch)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'create-release'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "${BRANCH_NAME}" = "main" ]; then
          gcloud deploy releases create release-${SHORT_SHA} \
            --delivery-pipeline=mizzou-news-crawler \
            --region=us-central1 \
            --annotations=commitId=${REVISION_ID} \
            --images=processor=us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/processor:${SHORT_SHA},api=us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/api:${SHORT_SHA},crawler=us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/crawler:${SHORT_SHA}
          echo "âœ… Created release for automatic deployment to production"
        else
          echo "â„¹ï¸  Skipping Cloud Deploy release - not on main branch"
          echo "   To manually deploy this build:"
          echo "   gcloud deploy releases create release-${SHORT_SHA} --delivery-pipeline=mizzou-news-crawler --region=us-central1 --images=processor=us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/processor:${SHORT_SHA},api=us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/api:${SHORT_SHA},crawler=us-central1-docker.pkg.dev/${PROJECT_ID}/mizzou-news-crawler/crawler:${SHORT_SHA}"
        fi
    waitFor: ['push-processor', 'push-api', 'push-crawler']

  # PHASE 4: Update Argo WorkflowTemplate to use new crawler image SHA (only on main branch)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'update-argo-workflow-template'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "${BRANCH_NAME}" = "main" ]; then
          echo "ðŸ”„ Updating Argo WorkflowTemplate to use crawler:${SHORT_SHA}..."
          
          # Get GKE credentials
          gcloud container clusters get-credentials mizzou-cluster \
            --zone=us-central1-a \
            --project=${PROJECT_ID}
          
          # Reuse helper script to patch workflow template images
          bash gcp/cloudbuild/update-workflow-template.sh crawler "${SHORT_SHA}"
          
          echo "âœ… Argo WorkflowTemplate updated to use crawler:${SHORT_SHA}"
          echo "   Next workflow run will use the new image"
        else
          echo "â„¹ï¸  Skipping Argo WorkflowTemplate update - not on main branch"
        fi
    waitFor: ['create-release']

options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '1800s'  # 30 minutes
